// AdjudicArts — Prisma Schema (Prisma 5)
// All entities carry organizationId for future multi-tenancy.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------------------------------------
// Enums
// ---------------------------------------------------------------------------

enum Role {
  ADMIN
  NATIONAL_CHAIR
  CHAPTER_CHAIR
  CHAPTER_JUDGE
  NATIONAL_JUDGE
  APPLICANT
}

enum EventStatus {
  DRAFT
  OPEN
  CHAPTER_REVIEW
  JUDGING
  NATIONAL_REVIEW
  DECIDED
  CLOSED
}

enum RoundType {
  CHAPTER
  NATIONAL
}

enum ApplicationStatus {
  SUBMITTED_PENDING_APPROVAL
  CHAPTER_ADJUDICATION
  NATIONAL_FINALS
  SUBMITTED
  CHAPTER_REVIEW
  CHAPTER_APPROVED
  CHAPTER_REJECTED
  NATIONAL_REVIEW
  NATIONAL_APPROVED
  NATIONAL_REJECTED
  DECIDED
}

enum ScoreRound {
  CHAPTER
  NATIONAL
}

enum NotificationFrequency {
  DAILY
}

enum NotificationKind {
  DAILY_DIGEST
}

enum NotificationChannel {
  IN_APP
  EMAIL
  SMS
}

enum EmailDeliveryStatus {
  PENDING
  SENT
  FAILED
}

// ---------------------------------------------------------------------------
// Organization
// Single-tenant for now; organizationId on all entities enables future multi-tenancy.
// ---------------------------------------------------------------------------

model Organization {
  id        String   @id @default(cuid())
  name      String
  plan      String   @default("starter")  // "starter" | "regional" | "national"
  status    String   @default("trial")    // "trial" | "active" | "suspended"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users          User[]
  events         Event[]
  rubrics        Rubric[]
  applications   Application[]
  notifications  Notification[]
  outboundEmails OutboundEmail[]
  inviteTokens   InviteToken[]
  supportTickets SupportTicket[]
}

// ---------------------------------------------------------------------------
// User
// ---------------------------------------------------------------------------

model User {
  id             String   @id @default(cuid())
  organizationId String
  email          String   @unique
  passwordHash   String
  name           String
  chapter        String?
  role           Role
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization     Organization      @relation(fields: [organizationId], references: [id])
  applications     Application[]
  scores           Score[]
  judgeAssignments JudgeAssignment[]
  notificationPreference NotificationPreference?
  notifications    Notification[]
  outboundEmails   OutboundEmail[]
  invitesSent      InviteToken[]     @relation("InvitesSent")
  ticketsSubmitted SupportTicket[]   @relation("TicketsSubmitted")

  @@index([organizationId])
  @@index([email])
  @@index([role])
  @@index([chapter])
}

// ---------------------------------------------------------------------------
// Event
// Status lifecycle: DRAFT → OPEN → CHAPTER_REVIEW → JUDGING → NATIONAL_REVIEW → DECIDED → CLOSED
// ---------------------------------------------------------------------------

model Event {
  id             String      @id @default(cuid())
  organizationId String
  name           String
  description    String?
  status         EventStatus @default(DRAFT)
  openAt         DateTime?
  closeAt        DateTime?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id])
  rounds       Round[]
  applications Application[]
  rubric       Rubric?

  @@index([organizationId])
  @@index([status])
}

// ---------------------------------------------------------------------------
// Round
// A chapter or national judging round that belongs to an Event.
// ---------------------------------------------------------------------------

model Round {
  id             String    @id @default(cuid())
  organizationId String
  eventId        String
  name           String
  type           RoundType
  startAt        DateTime?
  endAt          DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  event            Event             @relation(fields: [eventId], references: [id])
  judgeAssignments JudgeAssignment[]

  @@index([organizationId])
  @@index([eventId])
}

// ---------------------------------------------------------------------------
// Application
// An Applicant's submission for an Event.
// ---------------------------------------------------------------------------

model Application {
  id             String            @id @default(cuid())
  organizationId String
  eventId        String
  applicantId    String
  status         ApplicationStatus @default(SUBMITTED_PENDING_APPROVAL)
  repertoire     String?
  notes          String?
  chapter        String?
  dateOfBirth    DateTime?
  gender         String?
  phone          String?
  address        String?
  city           String?
  state          String?
  zip            String?
  schoolName     String?
  schoolCity     String?
  schoolState    String?
  highSchoolName String?
  collegeName    String?
  major          String?
  careerPlans    String?
  scholarshipUse String?
  video1Title    String?
  video2Title    String?
  video3Title    String?
  video1Url      String?
  video2Url      String?
  video3Url      String?
  youtubePlaylist String?
  headshot       String?
  bio            String?
  parentName     String?
  parentEmail    String?
  submittedAt    DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  event        Event        @relation(fields: [eventId], references: [id])
  applicant    User         @relation(fields: [applicantId], references: [id])
  scores       Score[]

  @@index([organizationId])
  @@index([eventId])
  @@index([applicantId])
  @@index([status])
}

// ---------------------------------------------------------------------------
// Rubric & RubricCriteria
// One Rubric per Event; each criterion scored 0–10.
// ---------------------------------------------------------------------------

model Rubric {
  id             String   @id @default(cuid())
  organizationId String
  eventId        String   @unique
  name           String
  description    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization    @relation(fields: [organizationId], references: [id])
  event        Event           @relation(fields: [eventId], references: [id])
  criteria     RubricCriteria[]

  @@index([organizationId])
}

model RubricCriteria {
  id          String   @id @default(cuid())
  rubricId    String
  name        String
  description String?
  weight      Float    @default(1.0)
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rubric Rubric  @relation(fields: [rubricId], references: [id], onDelete: Cascade)
  scores Score[]

  @@index([rubricId])
}

// ---------------------------------------------------------------------------
// Score
// A judge's score for one Application against one RubricCriteria (0–10).
// ---------------------------------------------------------------------------

model Score {
  id             String   @id @default(cuid())
  organizationId String
  applicationId  String
  criteriaId     String
  judgeId        String
  round          ScoreRound @default(CHAPTER)
  value          Float
  comment        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  application Application    @relation(fields: [applicationId], references: [id])
  criteria    RubricCriteria @relation(fields: [criteriaId], references: [id])
  judge       User           @relation(fields: [judgeId], references: [id])

  @@unique([applicationId, criteriaId, judgeId, round])
  @@index([organizationId])
  @@index([applicationId])
  @@index([judgeId])
}

// ---------------------------------------------------------------------------
// JudgeAssignment
// Links a Judge to a Round.
// ---------------------------------------------------------------------------

model JudgeAssignment {
  id             String   @id @default(cuid())
  organizationId String
  judgeId        String
  roundId        String
  createdAt      DateTime @default(now())

  judge User  @relation(fields: [judgeId], references: [id])
  round Round @relation(fields: [roundId], references: [id])

  @@unique([judgeId, roundId])
  @@index([organizationId])
  @@index([roundId])
}

model NotificationPreference {
  id           String                @id @default(cuid())
  userId       String                @unique
  enabled      Boolean               @default(true)
  channelInApp Boolean               @default(true)
  channelEmail Boolean               @default(true)
  channelSms   Boolean               @default(false)
  frequency    NotificationFrequency @default(DAILY)
  digestHour   Int                   @default(9)
  digestMinute Int                   @default(0)
  timezone     String                @default("America/Indiana/Indianapolis")
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([enabled])
}

model Notification {
  id             String              @id @default(cuid())
  organizationId String
  userId         String
  kind           NotificationKind
  channel        NotificationChannel
  title          String
  body           String
  linkUrl        String?
  digestDate     String?
  dedupeKey      String?             @unique
  readAt         DateTime?
  createdAt      DateTime            @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([userId, createdAt])
  @@index([kind])
}

model OutboundEmail {
  id             String              @id @default(cuid())
  organizationId String
  userId         String?
  toEmail        String
  subject        String
  htmlBody       String
  status         EmailDeliveryStatus @default(PENDING)
  provider       String?
  providerMessageId String?
  digestDate     String?
  dedupeKey      String?             @unique
  errorMessage   String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  sentAt         DateTime?

  organization Organization @relation(fields: [organizationId], references: [id])
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId, createdAt])
  @@index([userId, createdAt])
  @@index([status])
}

// ---------------------------------------------------------------------------
// SuperAdmin
// Platform-level admins (AdjudicArts staff) — completely separate from org users.
// ---------------------------------------------------------------------------

model SuperAdmin {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ---------------------------------------------------------------------------
// InviteToken
// One-time email invite links for org staff (ADMIN sends, recipient sets password).
// ---------------------------------------------------------------------------

model InviteToken {
  id             String    @id @default(cuid())
  organizationId String
  email          String
  role           Role
  name           String?
  tokenHash      String    @unique  // SHA-256 of raw token; raw token only in email link
  invitedById    String
  expiresAt      DateTime           // createdAt + 48h
  acceptedAt     DateTime?
  createdAt      DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  invitedBy    User         @relation("InvitesSent", fields: [invitedById], references: [id])

  @@index([tokenHash])
  @@index([email])
  @@index([organizationId])
}

// ---------------------------------------------------------------------------
// SupportTicket + SupportMessage
// Org users submit tickets; platform super-admins respond.
// ---------------------------------------------------------------------------

model SupportTicket {
  id             String   @id @default(cuid())
  organizationId String
  submittedById  String
  subject        String
  body           String
  status         String   @default("open")  // "open" | "in_progress" | "resolved"
  assignedToSAId String?                    // SuperAdmin.id if assigned
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization    @relation(fields: [organizationId], references: [id])
  submittedBy  User             @relation("TicketsSubmitted", fields: [submittedById], references: [id])
  messages     SupportMessage[]

  @@index([organizationId])
  @@index([status])
}

model SupportMessage {
  id        String   @id @default(cuid())
  ticketId  String
  body      String
  fromSA    Boolean  @default(false)  // true = sent by super-admin, false = sent by org user
  authorId  String                    // User.id or SuperAdmin.id
  createdAt DateTime @default(now())

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
}
